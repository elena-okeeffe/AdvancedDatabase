
USE WAREHOUSE GOPHER_WH;
USE DATABASE FALCON_LAB3_A2;
USE ROLE TRAINING_ROLE;

CREATE SCHEMA IF NOT EXISTS SILVER;


-- create silver layer tables
-- deduplicate rows and account for null values and general cleanup are applied here
-- cast columns to appropriate types

CREATE OR REPLACE TABLE SILVER.DIAGNOSTIC_LAB AS
SELECT
  NULLIF(TRIM(TEST_ID),'') AS TEST_ID,
  NULLIF(TRIM(PATIENT_ID),'') AS PATIENT_ID,
  NULLIF(TRIM(LAB_ID),'') AS LAB_ID,
  COALESCE(
    TRY_TO_TIMESTAMP(NULLIF(TRIM(TEST_DATE),'')),
    TRY_TO_TIMESTAMP(NULLIF(TRIM(TEST_DATE),''),'DD/MM/YYYY HH24:MI:SS')
  ) AS TEST_DATE,
  COALESCE(NULLIF(TRIM(TEST_TYPE),''),'UNKNOWN') AS TEST_TYPE,
  COALESCE(NULLIF(TRIM(TEST_NAME),''),'UNKNOWN') AS TEST_NAME,
  RESULT_VALUE,
  INGESTED_AT,
  CURRENT_TIMESTAMP() AS SILVER_LOADED_AT
FROM BRONZE.DIAGNOSTIC_LAB_DATA
WHERE
  NULLIF(TRIM(TEST_ID),'') IS NOT NULL
  AND NULLIF(TRIM(PATIENT_ID),'') IS NOT NULL
QUALIFY ROW_NUMBER() OVER (
  PARTITION BY NULLIF(TRIM(TEST_ID),'')
  ORDER BY INGESTED_AT DESC NULLS LAST
) = 1;


CREATE OR REPLACE TABLE SILVER.WEARABLE AS
SELECT
  TRY_CAST(PATIENT_ID AS NUMBER(38,0)) AS PATIENT_ID,
  DEVICE_ID,
  COALESCE(
    TRY_TO_TIMESTAMP("TIMESTAMP",'DD/MM/YYYY HH24:MI:SS'),
    TRY_TO_TIMESTAMP("TIMESTAMP")
  ) AS EVENT_TS,
  TRY_CAST(HEART_RATE AS NUMBER(38,0)) AS HEART_RATE,
  TRY_CAST(STEPS_COUNT AS NUMBER(38,0)) AS STEPS_COUNT,
  TRY_CAST(SLEEP_HOURS AS NUMBER(38,0)) AS SLEEP_HOURS,
  TRY_CAST(BLOOD_SUGAR_MGDL AS NUMBER(38,0)) AS BLOOD_SUGAR_MGDL,
  TRY_CAST(BP_SYSTOLIC_MMHG AS NUMBER(38,0)) AS BP_SYSTOLIC_MMHG,
  TRY_CAST(BP_DIASTOLIC_MMHG AS NUMBER(38,0)) AS BP_DIASTOLIC_MMHG,
  INGESTED_AT,
  CURRENT_TIMESTAMP() AS SILVER_LOADED_AT
FROM BRONZE.WEARABLE_DEVICE
WHERE
  TRY_CAST(PATIENT_ID AS NUMBER(38,0)) IS NOT NULL
  AND DEVICE_ID IS NOT NULL
  AND COALESCE(
    TRY_TO_TIMESTAMP("TIMESTAMP",'DD/MM/YYYY HH24:MI:SS'),
    TRY_TO_TIMESTAMP("TIMESTAMP")
  ) IS NOT NULL
QUALIFY ROW_NUMBER() OVER (
  PARTITION BY TRY_CAST(PATIENT_ID AS NUMBER(38,0)), DEVICE_ID,
               COALESCE(TRY_TO_TIMESTAMP("TIMESTAMP",'DD/MM/YYYY HH24:MI:SS'), TRY_TO_TIMESTAMP("TIMESTAMP"))
  ORDER BY INGESTED_AT DESC NULLS LAST
) = 1;


CREATE OR REPLACE TABLE SILVER.TREATMENTS AS
SELECT
  TRY_CAST(TREATMENT_ID AS NUMBER(38,0)) AS TREATMENT_ID,
  TREATMENT_START_DATE,
  TREATMENT_COMPLETION_DATE,
  COALESCE(TREATMENT_OUTCOME_STATUS,'UNKNOWN') AS TREATMENT_OUTCOME_STATUS,
  TREATMENT_OUTCOME_DATE,
  TRY_CAST(TREATMENT_DURATION AS NUMBER(38,0)) AS TREATMENT_DURATION,
  TRY_CAST(TREATMENT_COST AS NUMBER(38,0)) AS TREATMENT_COST,
  COALESCE(TREATMENT_TYPE,'UNKNOWN') AS TREATMENT_TYPE,
  TRY_CAST(PROVIDER_ID AS NUMBER(38,0)) AS PROVIDER_ID,
  PROVIDER_NAME,
  TRY_CAST(SPECIALITY_ID_X AS NUMBER(38,0)) AS SPECIALITY_ID_X,
  SPECIALITY_NAME,
  AFFILIATED_HOSPITAL,
  TRY_CAST(LOCATION_ID AS NUMBER(38,0)) AS LOCATION_ID,
  COUNTRY,
  STATE,
  CITY,
  TRY_CAST(PATIENT_ID AS NUMBER(38,0)) AS PATIENT_ID,
  PATIENT_NAME,
  GENDER,
  TRY_CAST(AGE AS NUMBER(38,0)) AS AGE,
  TRY_CAST(DISEASE_ID AS NUMBER(38,0)) AS DISEASE_ID,
  TRY_CAST(SPECIALITY_ID_Y AS NUMBER(38,0)) AS SPECIALITY_ID_Y,
  DISEASE_NAME,
  DISEASE_TYPE,
  SEVERITY,
  TRANSMISSION_MODE,
  TRY_CAST(MORTALITY_RATE AS NUMBER(38,2)) AS MORTALITY_RATE,
  ADDED_AT,
  MODIFIED_AT,
  INGESTED_AT,
  CURRENT_TIMESTAMP() AS SILVER_LOADED_AT
FROM BRONZE.TREATMENTS
WHERE TRY_CAST(TREATMENT_ID AS NUMBER(38,0)) IS NOT NULL
QUALIFY ROW_NUMBER() OVER (
  PARTITION BY TRY_CAST(TREATMENT_ID AS NUMBER(38,0))
  ORDER BY COALESCE(MODIFIED_AT, ADDED_AT, INGESTED_AT) DESC NULLS LAST
) = 1;
