
USE WAREHOUSE GOPHER_WH;
USE DATABASE FALCON_LAB3_A2;
USE ROLE TRAINING_ROLE;

CREATE SCHEMA IF NOT EXISTS GOLD;


-- create gold layer tables
-- these segregate the data in the silver layer into tables that align with the business use case

CREATE OR REPLACE TABLE GOLD.HOSPITAL AS
SELECT DISTINCT
  LOCATION_ID                  AS HOSPITAL_ID,
  AFFILIATED_HOSPITAL          AS HOSPITAL_NAME,
  COALESCE(
    NULLIF(CONCAT_WS(', ', CITY, STATE, COUNTRY), ''),
    AFFILIATED_HOSPITAL
  )                             AS LOCATION,
  NULL                          AS CAPACITY  -- this information is not available at this time
FROM SILVER.TREATMENTS
WHERE LOCATION_ID IS NOT NULL OR AFFILIATED_HOSPITAL IS NOT NULL;


CREATE OR REPLACE TABLE GOLD.HEALTH_PROVIDER AS
SELECT DISTINCT PROVIDER_ID, PROVIDER_NAME
FROM SILVER.TREATMENTS
WHERE PROVIDER_ID IS NOT NULL;


CREATE OR REPLACE TABLE GOLD.WEARABLE_DEVICE AS
SELECT
  DEVICE_ID,
  NULL            AS DEVICE_NAME,
  NULL            AS DEVICE_TYPE,
  EVENT_TS        AS TIMESTAMP,
  HEART_RATE      AS HEART_rate,
  STEPS_COUNT     AS Step_count,
  SLEEP_HOURS     AS Sleep_hours,
  BP_DIASTOLIC_MMHG AS BP_Diastolic_mmHg,
  BP_SYSTOLIC_MMHG  AS BP_Systolic_mmHg,
  BLOOD_SUGAR_MGDL  AS Blood_Sugar_mgdl
FROM SILVER.WEARABLE
WHERE DEVICE_ID IS NOT NULL;


CREATE OR REPLACE TABLE GOLD.PATIENT AS
SELECT DISTINCT
  PATIENT_ID                           AS PATIENT_ID,
  PATIENT_NAME                         AS PATIENT_NAME,
  GENDER                               AS GENDER,
  AGE                                  AS AGE
FROM SILVER.TREATMENTS
WHERE PATIENT_ID IS NOT NULL;


CREATE OR REPLACE TABLE GOLD.DIAGNOSTIC_LAB_DATA AS
SELECT
  LAB_ID AS Lab_ID,
  TEST_ID AS Test_ID,
  TEST_NAME AS Test_name,
  TEST_TYPE AS Test_Type,
  TEST_DATE AS Test_Date,
  RESULT_VALUE AS RESULT_VALUE,
  INGESTED_AT AS Ingested_at,
  TRY_CAST(PATIENT_ID AS NUMBER(38,0)) AS Patient_ID
FROM SILVER.DIAGNOSTIC_LAB;


CREATE OR REPLACE TABLE GOLD.TREATMENT AS
SELECT
  TREATMENT_ID AS Treatment_ID,
  TREATMENT_TYPE AS Treatment_Type,
  TREATMENT_COST AS Treatment_Cost,
  TREATMENT_START_DATE AS Treatment_Start_date,
  TREATMENT_COMPLETION_DATE AS Treatment_Completion_date,
  TREATMENT_DURATION AS Treatment_Duration,
  TREATMENT_OUTCOME_STATUS AS Treatment_Outcome_Status,
  TRY_CAST(PATIENT_ID AS NUMBER(38,0)) AS Patient_ID,
  PROVIDER_ID AS Provider_ID
FROM SILVER.TREATMENTS
WHERE TREATMENT_ID IS NOT NULL;

 
CREATE OR REPLACE TABLE GOLD.ENCOUNTER AS
SELECT
  t.TREATMENT_ID                         AS Encounter_ID,
  t.TREATMENT_START_DATE                 AS Admission_Date,
  t.TREATMENT_COMPLETION_DATE            AS Discharge_Date,
  DATEDIFF('day', t.TREATMENT_START_DATE, t.TREATMENT_COMPLETION_DATE) AS Length_of_Stay,
  TRY_CAST(t.PATIENT_ID AS NUMBER(38,0)) AS Patient_ID,
  t.LOCATION_ID                          AS Hospital_ID
FROM SILVER.TREATMENTS t
WHERE t.TREATMENT_ID IS NOT NULL;


