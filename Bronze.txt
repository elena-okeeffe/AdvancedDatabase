
USE WAREHOUSE GOPHER_WH;
USE DATABASE FALCON_LAB3_A2;
USE ROLE TRAINING_ROLE;

CREATE SCHEMA IF NOT EXISTS BRONZE;


-- Create Bronze layer tables with raw data
CREATE TABLE IF NOT EXISTS BRONZE.DIAGNOSTIC_LAB_DATA (
  TEST_ID VARCHAR,
  PATIENT_ID VARCHAR,
  LAB_ID VARCHAR,
  TEST_DATE VARCHAR,
  TEST_TYPE VARCHAR,
  TEST_NAME VARCHAR,
  RESULT_VALUE VARCHAR,
  INGESTED_AT TIMESTAMP_NTZ DEFAULT CURRENT_TIMESTAMP()
);

CREATE TABLE IF NOT EXISTS BRONZE.WEARABLE_DEVICE (
  PATIENT_ID NUMBER(38,0),
  DEVICE_ID VARCHAR(255),
  "TIMESTAMP" VARCHAR(255),
  HEART_RATE NUMBER(38,0),
  STEPS_COUNT NUMBER(38,0),
  SLEEP_HOURS NUMBER(38,0),
  BLOOD_SUGAR_MGDL NUMBER(38,0),
  BP_SYSTOLIC_MMHG NUMBER(38,0),
  BP_DIASTOLIC_MMHG NUMBER(38,0),
  INGESTED_AT TIMESTAMP_NTZ DEFAULT CURRENT_TIMESTAMP()
);

CREATE TABLE IF NOT EXISTS BRONZE.TREATMENTS (
  TREATMENT_ID NUMBER(38,0),
  TREATMENT_START_DATE TIMESTAMP_NTZ(9),
  TREATMENT_COMPLETION_DATE TIMESTAMP_NTZ(9),
  TREATMENT_OUTCOME_STATUS VARCHAR(255),
  TREATMENT_OUTCOME_DATE TIMESTAMP_NTZ(9),
  TREATMENT_DURATION NUMBER(38,0),
  TREATMENT_COST NUMBER(38,0),
  TREATMENT_TYPE VARCHAR(255),
  PROVIDER_ID NUMBER(38,0),
  PROVIDER_NAME VARCHAR(255),
  SPECIALITY_ID_X NUMBER(38,0),
  SPECIALITY_NAME VARCHAR(255),
  AFFILIATED_HOSPITAL VARCHAR(255),
  LOCATION_ID NUMBER(38,0),
  COUNTRY VARCHAR(255),
  STATE VARCHAR(255),
  CITY VARCHAR(255),
  PATIENT_ID NUMBER(38,0),
  PATIENT_NAME VARCHAR(255),
  GENDER VARCHAR(255),
  AGE NUMBER(38,0),
  DISEASE_ID NUMBER(38,0),
  SPECIALITY_ID_Y NUMBER(38,0),
  DISEASE_NAME VARCHAR(255),
  DISEASE_TYPE VARCHAR(255),
  SEVERITY VARCHAR(255),
  TRANSMISSION_MODE VARCHAR(255),
  MORTALITY_RATE NUMBER(38,2),
  ADDED_AT TIMESTAMP_NTZ(9),
  MODIFIED_AT TIMESTAMP_NTZ(9),
  INGESTED_AT TIMESTAMP_NTZ DEFAULT CURRENT_TIMESTAMP()
);


-- for the purposes of this exercise a snowpipe was not set up
-- to simulate adding data into the bronze layer we have synthetic data included in tables in the public schema
INSERT INTO BRONZE.DIAGNOSTIC_LAB_DATA (
  TEST_ID, PATIENT_ID, LAB_ID, TEST_DATE, TEST_TYPE, TEST_NAME, RESULT_VALUE, INGESTED_AT
)
SELECT
  TEST_ID,
  PATIENT_ID,
  LAB_ID,
  TEST_DATE,
  TEST_TYPE,
  TEST_NAME,
  RESULT_VALUE,
  CURRENT_TIMESTAMP()
FROM PUBLIC.DIAGNOSTIC_LAB_DATA;

INSERT INTO BRONZE.WEARABLE_DEVICE (
  PATIENT_ID, DEVICE_ID, "TIMESTAMP", HEART_RATE, STEPS_COUNT, SLEEP_HOURS,
  BLOOD_SUGAR_MGDL, BP_SYSTOLIC_MMHG, BP_DIASTOLIC_MMHG, INGESTED_AT
)
SELECT
  PATIENT_ID,
  DEVICE_ID,
  "TIMESTAMP",
  HEART_RATE,
  STEPS_COUNT,
  SLEEP_HOURS,
  BLOOD_SUGAR_MGDL,
  BP_SYSTOLIC_MMHG,
  BP_DIASTOLIC_MMHG,
  CURRENT_TIMESTAMP()
FROM PUBLIC.WEARABLE_DEVICE;

INSERT INTO BRONZE.TREATMENTS (TREATMENT_ID, TREATMENT_START_DATE, TREATMENT_COMPLETION_DATE, TREATMENT_OUTCOME_STATUS, TREATMENT_OUTCOME_DATE, TREATMENT_DURATION, TREATMENT_COST, TREATMENT_TYPE, PROVIDER_ID, PROVIDER_NAME, SPECIALITY_ID_X, SPECIALITY_NAME, AFFILIATED_HOSPITAL, LOCATION_ID, COUNTRY, STATE, CITY, PATIENT_ID, PATIENT_NAME, GENDER, AGE, DISEASE_ID, SPECIALITY_ID_Y, DISEASE_NAME, DISEASE_TYPE, SEVERITY, TRANSMISSION_MODE, MORTALITY_RATE, ADDED_AT, MODIFIED_AT, INGESTED_AT)
SELECT TREATMENT_ID, TREATMENT_START_DATE, TREATMENT_COMPLETION_DATE, TREATMENT_OUTCOME_STATUS, TREATMENT_OUTCOME_DATE, TREATMENT_DURATION, TREATMENT_COST, TREATMENT_TYPE, PROVIDER_ID, PROVIDER_NAME, SPECIALITY_ID_X, SPECIALITY_NAME, AFFILIATED_HOSPITAL, LOCATION_ID, COUNTRY, STATE, CITY, PATIENT_ID, PATIENT_NAME, GENDER, AGE, DISEASE_ID, SPECIALITY_ID_Y, DISEASE_NAME, DISEASE_TYPE, SEVERITY, TRANSMISSION_MODE, MORTALITY_RATE, ADDED_AT, MODIFIED_AT, CURRENT_TIMESTAMP()
FROM PUBLIC.TREATMENTS;
